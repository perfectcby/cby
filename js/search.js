class ProductSearch{constructor(){this.searchInput=document.getElementById("search-input"),this.searchBtn=document.getElementById("search-btn"),this.clearSearchBtn=document.getElementById("clear-search"),this.searchSuggestions=document.getElementById("search-suggestions"),this.searchLoading=document.getElementById("search-loading"),this.MIN_INPUT_LENGTH=2,this.MAX_SUGGESTIONS=8,this.DEBOUNCE_DELAY=200,this.SEARCH_HISTORY_KEY="productSearchHistory",this.MAX_HISTORY_ITEMS=5,this.searchCache=new Map,this.currentSuggestionIndex=-1,this.debounceTimer=null,this.seriesRules={HMI:{patterns:[/^IT7/,/^ITS7/,/^IT9/],dataKey:"hmiData"},PLC:{patterns:[/^IS2/,/^IS3/,/^IP1/,/^IP2/,/^AM/,/^AC/,/^AI/,/^PLC-/],dataKey:"plcData"},Servo:{patterns:[/^SV6/,/^SV7/,/^SV8/,/^MS1/,/^S6/],dataKey:"servoSystemData"},Inverter:{patterns:[/^MD2/,/^MD3/,/^MD5/],dataKey:"inverterData"},IO:{patterns:[/^IO/,/^IS6/],dataKey:"ioData"}},this.allModels=this.initializeAllModels(),this.bindEvents()}initializeAllModels(){let a=[];return["hmiData","plcData","servoSystemData","inverterData","ioData"].forEach(s=>{let e=window[s];e&&Object.keys(e).forEach(t=>{"ioData"===s?Object.values(e[t]).forEach(e=>{Object.values(e).forEach(e=>{e.model&&a.push({model:e.model,normalizedModel:this.normalizeInput(e.model),productType:this.getProductTypeFromDataKey(s),dataKey:s,series:t,product:e})})}):"servoSystemData"===s?Object.values(e[t]).forEach(e=>{Object.entries(e).forEach(([,e])=>{e["伺服电机"]&&e["伺服电机"].model&&(e=e["伺服电机"],a.push({model:e.model,normalizedModel:this.normalizeInput(e.model),productType:this.getProductTypeFromDataKey(s),dataKey:s,series:t,product:e}))})}):Object.values(e[t]).forEach(e=>{e.model&&a.push({model:e.model,normalizedModel:this.normalizeInput(e.model),productType:this.getProductTypeFromDataKey(s),dataKey:s,series:t,product:e})})})}),a}getProductTypeFromDataKey(e){return{hmiData:"HMI",plcData:"PLC",servoSystemData:"Servo",inverterData:"Inverter",ioData:"IO"}[e]||""}bindEvents(){this.searchBtn.addEventListener("click",()=>this.performSearch()),this.searchInput.addEventListener("input",e=>this.handleInput(e)),this.searchInput.addEventListener("keydown",e=>this.handleKeydown(e)),this.searchInput.addEventListener("focus",()=>this.showSuggestions()),this.clearSearchBtn.addEventListener("click",()=>this.clearSearch()),document.addEventListener("click",e=>{this.searchInput.contains(e.target)||this.searchSuggestions.contains(e.target)||this.hideSuggestions()}),this.loadSearchHistory()}handleInput(e){let t=e.target.value.trim();this.clearSearchBtn.style.display=t?"inline-block":"none",clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.generateSuggestions(t)},this.DEBOUNCE_DELAY)}handleKeydown(e){var t=this.searchSuggestions.querySelectorAll(".suggestion-item");switch(e.key){case"ArrowDown":e.preventDefault(),this.navigateSuggestions(1,t);break;case"ArrowUp":e.preventDefault(),this.navigateSuggestions(-1,t);break;case"Enter":e.preventDefault(),0<=this.currentSuggestionIndex&&this.currentSuggestionIndex<t.length?this.selectSuggestion(t[this.currentSuggestionIndex]):this.performSearch();break;case"Escape":this.hideSuggestions()}}navigateSuggestions(e,t){0!==t.length&&(0<=this.currentSuggestionIndex&&this.currentSuggestionIndex<t.length&&t[this.currentSuggestionIndex].classList.remove("highlighted"),this.currentSuggestionIndex+=e,this.currentSuggestionIndex>=t.length?this.currentSuggestionIndex=0:this.currentSuggestionIndex<0&&(this.currentSuggestionIndex=t.length-1),t[this.currentSuggestionIndex].classList.add("highlighted"),t[this.currentSuggestionIndex].scrollIntoView({block:"nearest"}))}normalizeInput(e){let t=e.trim().replace(/\s+/g,"");return t=(t=(t=t.toUpperCase()).replace(/‑/g,"-")).replace(/[^A-Z0-9-_]/g,"")}identifySeries(e){for(var[t,s]of Object.entries(this.seriesRules))for(var a of s.patterns)if(a.test(e))return{productType:t,dataKey:s.dataKey};return{productType:"",dataKey:""}}generateSuggestions(e){if(e.length<this.MIN_INPUT_LENGTH)this.hideSuggestions();else{let i=this.normalizeInput(e),t="suggestions_"+i;this.searchCache.has(t)?this.displaySuggestions(this.searchCache.get(t)):(this.showLoading(),setTimeout(()=>{this.allModels=this.initializeAllModels();var e=this.allModels.filter(e=>e.normalizedModel.includes(i)),e=e.sort((e,t)=>{var s=e.model.toUpperCase().startsWith(i),a=t.model.toUpperCase().startsWith(i);return s&&!a?-1:!s&&a?1:e.model.length-t.model.length}).slice(0,this.MAX_SUGGESTIONS);this.searchCache.set(t,e),this.displaySuggestions(e),this.hideLoading()},100))}}displaySuggestions(e){this.searchSuggestions.innerHTML="",0===e.length?this.hideSuggestions():(e.forEach((e,t)=>{let s=document.createElement("div");s.className="suggestion-item",s.dataset.model=e.model,s.dataset.productType=e.productType,s.dataset.dataKey=e.dataKey;var a=e.model.toUpperCase().indexOf(this.normalizeInput(this.searchInput.value)),a=0<=a?e.model.substring(0,a)+`<strong>${e.model.substring(a,a+this.searchInput.value.length)}</strong>`+e.model.substring(a+this.searchInput.value.length):e.model;s.innerHTML=`
                <div class="suggestion-model">${a}</div>
                <div class="suggestion-type">${this.getProductTypeName(e.productType)}</div>
            `,s.addEventListener("click",()=>this.selectSuggestion(s)),this.searchSuggestions.appendChild(s)}),this.searchSuggestions.style.display="block",this.searchSuggestions.style.position="absolute",this.searchSuggestions.style.zIndex="1000",this.currentSuggestionIndex=-1)}getProductTypeName(e){return{HMI:"人机界面",PLC:"PLC控制器",Servo:"伺服系统",Inverter:"变频器",IO:"IO模块"}[e]||e}selectSuggestion(e){e=e.dataset.model;this.searchInput.value=e,this.hideSuggestions(),this.performSearch()}showSuggestions(){var e=this.searchInput.value.trim();e.length>=this.MIN_INPUT_LENGTH&&this.generateSuggestions(e)}hideSuggestions(){this.searchSuggestions.style.display="none",this.currentSuggestionIndex=-1}showLoading(){this.searchLoading.style.display="inline-block"}hideLoading(){this.searchLoading.style.display="none"}performSearch(){let t=this.searchInput.value.trim();if(t){let i=this.normalizeInput(t),e=(this.showLoading(),"search_"+i);this.searchCache.has(e)?(this.handleSearchResults(this.searchCache.get(e)),this.hideLoading()):setTimeout(()=>{let s=this.identifySeries(t),a=[];s.dataKey&&window[s.dataKey]?Object.values(window[s.dataKey]).forEach(e=>{"ioData"===s.dataKey?Object.values(e).forEach(e=>{Object.values(e).forEach(e=>{var t=this.normalizeInput(e.model);e.model&&t===i&&a.push({...e,productType:s.productType,dataKey:s.dataKey})})}):"servoSystemData"===s.dataKey?Object.values(e).forEach(e=>{Object.entries(e).forEach(([,e])=>{e["伺服电机"]&&e["伺服电机"].model&&(e=e["伺服电机"],this.normalizeInput(e.model)===i)&&a.push({...e,productType:s.productType,dataKey:s.dataKey})})}):Object.values(e).forEach(e=>{var t=this.normalizeInput(e.model);e.model&&t===i&&a.push({...e,productType:s.productType,dataKey:s.dataKey})})}):this.allModels.forEach(e=>{e.normalizedModel===i&&a.push({...e.product,productType:e.productType,dataKey:e.dataKey})}),this.searchCache.set(e,a),this.handleSearchResults(a),this.hideLoading(),this.saveSearchHistory(i)},150)}}handleSearchResults(e){var t;0===e.length?this.showNoResults():(e=e[0].productType,t={model:this.searchInput.value.trim()},window.pageRouter&&"function"==typeof window.pageRouter.showResultPage?window.pageRouter.showResultPage(e,t):(e=new CustomEvent("showFilterResults",{detail:{productType:e,filterData:t}}),document.dispatchEvent(e)))}showNoResults(){alert("未找到匹配的产品型号，请尝试其他型号或查看相关产品建议。")}navigateToProductDetail(e){var t;window.pageRouter&&(t=e.productType.toLowerCase()+"Result",window.pageRouter.showPage(t),t=new CustomEvent("showProductDetail",{detail:{productType:e.productType,product:e}}),document.dispatchEvent(t))}navigateToFilteredResults(e){var t,s,a;window.pageRouter&&0<e.length&&(s=(a=e[0].productType).toLowerCase()+"Result",t=a.toLowerCase()+"ResultContent",window.pageRouter.showPage(s),s=this.getProductTypeName(a),document.getElementById(t))&&(a=a.toLowerCase()+"Type",a=window[a]&&window[a].displayParams?window[a].displayParams:["型号","价格"],"function"==typeof window.displayResults?window.displayResults(t,e,a,s,[]):displayResults(t,e,a,s,[]))}clearSearch(){this.searchInput.value="",this.clearSearchBtn.style.display="none",this.hideSuggestions(),this.searchInput.focus()}loadSearchHistory(){var e=window.localStorageManager.getItem(this.SEARCH_HISTORY_KEY)||[];this.searchHistory=Array.isArray(e)?e:[]}saveSearchHistory(t){this.searchHistory=this.searchHistory.filter(e=>e!==t),this.searchHistory.unshift(t),this.searchHistory.length>this.MAX_HISTORY_ITEMS&&(this.searchHistory=this.searchHistory.slice(0,this.MAX_HISTORY_ITEMS)),window.localStorageManager.setItem(this.SEARCH_HISTORY_KEY,this.searchHistory)}getSearchHistory(){return this.searchHistory}clearSearchHistory(){this.searchHistory=[],window.localStorageManager.removeItem(this.SEARCH_HISTORY_KEY)}}document.addEventListener("DOMContentLoaded",function(){window.productSearch||(window.productSearch=new ProductSearch)});